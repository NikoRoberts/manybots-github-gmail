<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>Manybots Gmail Github Visualization</title>

 <style type='text/css'>
    /* style up the tooltips content */
    p{margin:0;}
.charlab { font-face: helvetica, arial; color: black; margin: 0; }
.date { font-size: 10px; font-weight: normal }
.visits { color: #5Af; font-weight: normal }
.hits { color: #F80; font-weight: normal }
.label { font-size: 12px; line-height: 14px; margin-left: 2px; font-weight: bold }

  </style>
  
</head>
<body>
  <!-- the div where we are going to plot -->
<div id="chart" style="width: 100%; height: 200px"></div>
  
  
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
<script src="https://www.manybots.com/javascripts/manybots.js" type="text/javascript"></script>
<script src="http://documentcloud.github.com/underscore/underscore-min.js" type="text/javascript"></script>
<script type='text/javascript' src='http://code.jquery.com/jquery-1.7.1.js'></script>
<script type='text/javascript' src="http://elycharts.com/sites/elycharts.com/repo/dist/elycharts.min.js"></script>    
<script type='text/javascript' src="http://elycharts.com/sites/elycharts.com/repo/lib/raphael.js"></script>
<script src="https://www.manybots.com/javascripts/manybots.js" type="text/javascript"></script>
<script type='text/javascript' src='http://nikoroberts.github.com/manybots-github-gmail/javascripts/json.js'></script>

<script type='text/javascript'>//<![CDATA[ 

var emails = new Array(31),
commits = new Array(31);

var //flags to know if async calls is waiting or finished
flagemails=0,
flagcommits=0; //0 = not called, 1 = called and waiting for response, 2 = received response

function loop() {
  if(flagemails==0 && flagcommits==0)
  {
    var client = new ManybotsClient();
    var efilter = {
      'objects' : 'email'
    };
    var cfilter = {
      'objects' : 'commit'
    };
  }
  if(flagemails==0)
  {
    flagemails=1;
    client.getJSON('/activities', {'filter':efilter, 'limit': 500}, function(stream) {
      flagemails=2;
      var activities = stream.data.items;
      var count = activities.length;
      
      /* use underscore to group the activities by their day of the month */
      var temails = _.groupBy(activities, function(item) { 
        var published = new Date((item.published).replace(/-/g,"/").replace(/[TZ]/g," "));
        console.log('found ' + published + ' emails'+ published.getDate());
        return published.getDate(); /* this gets the day of the month not the date as you might suspect */
      });
      
      /* now we loop through the grouped results and put the counts in the day of the month array */
      for(var i = 0;i<31;i++) {
        if(typeof temails[(i+1).toString()] != "undefined") {
          emails[i] = temails[(i+1).toString()].length;
        }
        else {
          emails[i] = 0;
        }
      }
    });
  }
  if(flagcommits==0)
  {
    flagcommits=1;
    client.getJSON('/activities', {'filter':cfilter, 'limit': 500}, function(stream) {
      flagcommits=2;
      var activities = stream.data.items;
      var count = activities.length;
      
      /* use underscore to group the activities by their day of the month */
      var tcommits = _.groupBy(activities, function(item) { 
        var published = new Date((item.published).replace(/-/g,"/").replace(/[TZ]/g," "));
        return published.getDate(); 
      });
      
      /* now we loop through the grouped results and put the counts in the day of the month array */
      for(var i = 0;i<31;i++) {
        if(typeof tcommits[(i+1).toString()] != "undefined") {
          commits[i] = tcommits[(i+1).toString()].length;
        }
        else {
          commits[i] = 0;
        }
      }
      
    });
  }
  if(flagemails==2 && flagcommits==2)
  {
    $("#chart").chart({
      values: {
        serie1: emails,
        serie2: commits
      }
    });
  }
  else {
    setTimeout('loop()', 5000);
  }
}


$(function() {
    // let's loop to build tooltips and x labels.
    var thelabels = new Array(30);
    for (var i = 0; i < thelabels.length; i++) {
        thelabels[i] = (i % 6 === 0) ? (i + 1) + " september" : "";
    }

    // build the chart with no data but only x axis labels using the "google analytics" template.
    $("#chart").chart({
        template: "google_analytics",
        labels: thelabels,
    });

    // start a loop that sets new data in the chart every 5 seconds.
    loop();
});

// this is a reausable template definition.
$.elycharts.templates['google_analytics'] = {
    type: "line",
    margins: [10, 15, 25, 15],
    /* Define how to draw tooltips starting from series data */
    /* this can be an array with the tooltips content or a function to generate them on the fly */
    tooltips: function(env, serie, index, value, label) {
        return "<div class='label'><p class='date'>Day " + index + "</p><p><span class='visits'>Emails:</span> " + env.opt.values['serie1'][index] + "</p><p><span class='hits'>Commits:</span> " + env.opt.values['serie2'][index] + "</p></div>";
    },
    defaultSeries: {
        plotProps: {
            "stroke-width": 4
        },
        dot: true,
        rounded: false,
        dotProps: {
            stroke: "white",
            size: 5,
            "stroke-width": 1,
            opacity: 0 // dots invisible until we hover it
        },
        startAnimation: { // use an animation to start plotting the chart
            active: true,
            type: "avg", // start from the average line.
            speed: 1000, // animate in 1 second.
            easing: ">"
        },
        stepAnimation: { // defines an animation for data updates
            speed: 2000,
            delay: 0,
            easing: '<>'
        },
        highlight: {
            scaleSpeed: 0, // do not animate the dot scaling. instant grow.
            scaleEasing: '',
            scale: 1.2, // enlarge the dot on hover
            newProps: {
                opacity: 1 // show dots on hover
            }
        },
        tooltip: {
            height: 45,
            width: 80,
            padding: [3, 3],
            offset: [-15, -10],
            frameProps: {
                opacity: 0.95,
                /* fill: "white", */
                stroke: "#000"

            }
        }
    },
    series: {
        serie1: {
            fill: true,
            fillProps: {
                opacity: .1
            },
            color: "#26B",
        },
        serie2: {
            axis: 'r',
            color: "#F80",
            plotProps: {
                "stroke-width": 2
            },
            dotProps: {
                stroke: "white",
                size: 3,
                "stroke-width": 1
            }
        }

    },
    defaultAxis: {
        labels: true,
        labelsProps: {
            fill: "#49B",
            "font-size": "10px"
        },
        labelsAnchor: "start",
        labelsMargin: 5,
        labelsDistance: -8
    },
    axis: {
        l: { // left axis
            labels: true,
            labelsDistance: 0,
            labelsSkip: 1,
            labelsAnchor: "start",
            labelsMargin: 15,
            labelsProps: {
                fill: "#AAA",
                "font-size": "11px",
                "font-weight": "bold"
            }
        },
        r: { // left axis
            labels: true,
            labelsDistance: 0,
            labelsSkip: 1,
            labelsAnchor: "end",
            labelsMargin: 15,
            labelsProps: {
                fill: "#AAA",
                "font-size": "11px",
                "font-weight": "bold"
            }
        }
    },
    features: {
        mousearea: {
            type: 'axis'
        },
        tooltip: {
            positionHandler: function(env, tooltipConf, mouseAreaData, suggestedX, suggestedY) {
                return [mouseAreaData.event.pageX, mouseAreaData.event.pageY, true]
            }
        },
        grid: {
            draw: true, // draw both x and y grids
            forceBorder: [true, false, true, false], // force grid for external border
            ny: 2, // use 10 divisions for y grid
            nx: 5, // 10 divisions for x grid
            props: {
                stroke: "#CCC" // color for the grid
            }
        }
    }
}

</script>

</body>
</html>